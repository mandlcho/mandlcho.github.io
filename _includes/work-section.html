{% assign cards = include.items %}
{% assign eyebrow = include.eyebrow | default: "latest cycles" %}
{% assign section_title = include.title | default: page.title | default: "projects" %}
{% assign section_description = include.description | default: page.description %}
{% assign empty_message = include.empty_message | default: "More builds coming soon." %}

<section class="projects-page {% if include.page_type %}projects-page--{{ include.page_type }}{% endif %}">
  <header class="projects-page__intro">
    <p class="projects-page__eyebrow">{{ eyebrow }}</p>
    <h1 class="projects-page__title">{{ section_title }}</h1>
    <div class="projects-page__header-container">
      {% if section_description %}
        <p class="projects-page__description">{{ section_description }}</p>
      {% endif %}
    </div>
  </header>

  <div class="projects-grid" id="projects-grid">
    {% if cards and cards.size > 0 %}
      {% for item in cards %}
        {% assign repo = item.repo %}
        {% assign project_href = item.url | default: "" %}
        {% if project_href == "" and repo %}
          {% assign project_href = "https://github.com/" | append: repo %}
        {% elsif project_href != "" %}
          {% unless project_href contains "://" %}
            {% assign project_href = project_href | relative_url %}
          {% endunless %}
        {% endif %}
        {% if project_href == "" %}
          {% assign project_href = "#" %}
        {% endif %}
{% assign case_post = nil %}
{% if item.case_study_slug %}
  {% assign case_post = site.posts | where: "slug", item.case_study_slug | first %}
{% endif %}
{% assign has_case_panel = item.case_study_slug %}
{% assign language_label = item.language_label | default: item.language %}
{% assign language_color = item.language_color | default: "rgba(148, 163, 184, 0.6)" %}
{% assign show_language = language_label or item.language_color %}
{% assign project_image = item.image %}
{% if project_image %}
  {% unless project_image contains "://" %}
    {% assign project_image = project_image | relative_url %}
  {% endunless %}
{% endif %}
{% assign image_alt = item.image_alt | default: item.name | default: section_title %}
{% assign project_video_url = "" %}
{% if include.page_type == "games" %}
  {% assign project_video_url = item.video_url | default: item.video | default: "" %}
{% endif %}
{% assign has_video = project_video_url and project_video_url != "" %}
{% assign project_language_value = language_label | default: item.language | default: "" %}
{% assign project_type = item.project_type | default: item.type | default: item.status | default: "source" %}
{% assign project_summary = item.summary | default: "" %}
<article
  class="project-card"
  style="--card-index: {{ forloop.index0 | default: 0 }}"
  {% if repo %}data-repo="{{ repo }}"{% endif %}
  data-project-card
  data-name="{{ item.name | downcase | escape }}"
  data-summary="{{ project_summary | strip_newlines | downcase | escape }}"
  data-last-updated="{{ item.last_updated }}"
  data-date-added="{{ item.date_added }}"
  data-language="{{ project_language_value | escape }}"
  data-language-normalized="{{ project_language_value | downcase | escape }}"
  data-type="{{ project_type | downcase | escape }}"
>
  {% if project_image %}
    <figure class="project-card__media"{% if item.splat_model %} data-splat-model="{{ item.splat_model | relative_url }}"{% endif %}>
      <img src="{{ project_image }}" alt="{{ image_alt }}" loading="lazy" />
    </figure>
  {% endif %}
  <header class="project-card__header">
            <div class="project-card__identity">
              <svg
                class="project-card__icon"
                viewBox="0 0 16 16"
                aria-hidden="true"
                focusable="false"
              >
                <path
                  d="M2 2.75A1.75 1.75 0 0 1 3.75 1h8.5A1.75 1.75 0 0 1 14 2.75v10.5A1.75 1.75 0 0 1 12.25 15H3.75A1.75 1.75 0 0 1 2 13.25Zm1.75-.25a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25Z"
                />
              </svg>
              {% if repo %}
                <a class="project-card__name" href="{{ project_href }}">
                  <span class="project-card__owner">
                    {{ repo | split: "/" | first }}
                  </span>
                  <span class="project-card__slash">/</span>
                  <span class="project-card__repo">
                    {{ repo | split: "/" | last }}
                  </span>
                </a>
              {% else %}
                {% assign display_name = item.display_name | default: item.name | default: section_title %}
                <a class="project-card__name" href="{{ project_href }}">
                  {{ display_name }}
                </a>
              {% endif %}
            </div>
            {% if item.status %}
              <span class="project-card__status">
                {{ item.status }}
              </span>
            {% endif %}
          </header>

          {% if item.summary %}
            <p class="project-card__summary">
              {{ item.summary }}
            </p>
          {% endif %}

          {% if has_video %}
            <div class="project-card__actions">
              <button
                class="project-card__action project-card__action--video"
                type="button"
                data-video-toggle
                aria-expanded="false"
                aria-controls="video-{{ forloop.index0 }}"
              >
                <span class="project-card__action-icon" aria-hidden="true">▶</span>
                <span data-video-toggle-label>Show reel</span>
              </button>
            </div>
            <div
              class="project-card__video"
              id="video-{{ forloop.index0 }}"
              data-video-panel
              data-vimeo-url="{{ project_video_url | escape }}"
              data-video-title="{{ item.name | default: section_title | escape }}"
              hidden
            >
              <div class="project-card__video-frame" data-video-frame></div>
            </div>
          {% endif %}

          {% assign has_footer = show_language or repo %}
          {% if has_footer %}
            <div class="project-card__footer">
              {% if show_language %}
                <span class="project-card__language">
                  <span
                    class="project-card__language-swatch"
                    data-language-swatch
                    style="--lang-color: {{ language_color }};"
                  ></span>
                  <span class="project-card__language-label" data-language-label>
                    {{ language_label }}
                  </span>
                </span>
              {% endif %}
              {% if repo %}
                <div class="project-card__stats">
                  <span class="project-card__stat project-card__stat--stars">
                    <svg
                      viewBox="0 0 16 16"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path
                        d="M8 .981 10.09 6.26l5.527.2-4.3 3.402 1.434 5.356L8 12.735l-4.75 2.483 1.434-5.356-4.3-3.403 5.527-.199Z"
                      />
                    </svg>
                    <span class="project-card__stat-value" data-stars-value>—</span>
                  </span>
                  <span class="project-card__stat project-card__stat--forks">
                    <svg
                      viewBox="0 0 16 16"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path
                        d="M5.5 3.25a2.25 2.25 0 1 0-3 2.122v2.256a2.25 2.25 0 1 0 1.5 0V5.372a2.251 2.251 0 0 0 1.5-2.122m-2.25.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5m0 6a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5M10.5.5a2.25 2.25 0 0 0-1.5 3.872v5.256a2.25 2.25 0 1 0 1.5 0V4.372A2.25 2.25 0 0 0 10.5.5m0 3a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5m0 8a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5"
                      />
                    </svg>
                    <span class="project-card__stat-value" data-forks-value>—</span>
                  </span>
                  <span class="project-card__stat project-card__stat--updated" data-updated-value>
                    updated — syncing...
                  </span>
                </div>
              {% endif %}
            </div>
          {% endif %}

          {% if has_case_panel %}
            <div class="project-card__process">
              <button
                class="project-card__process-link"
                type="button"
                data-project-toggle
                aria-expanded="false"
              >
                <span data-toggle-label>View process</span>
              </button>
            </div>
            <div class="project-card__details" data-project-details hidden>
              {% if case_post %}
                <article class="project-card__case">
                  <header class="project-card__case-header">
                    <p class="project-card__case-eyebrow">
                      {{ case_post.date | date: "%b %d, %Y" }}
                    </p>
                    <h3 class="project-card__case-title">{{ case_post.title }}</h3>
                  </header>
                  <div class="project-card__case-body">
                    {{ case_post.content }}
                  </div>
                </article>
              {% else %}
                <p class="project-card__case-empty">
                  Process blog coming soon.
                </p>
              {% endif %}
            </div>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="projects-page__empty">{{ empty_message }}</p>
    {% endif %}
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const projectsGrid = document.getElementById("projects-grid");
    const projectCards = projectsGrid ? Array.from(projectsGrid.querySelectorAll(".project-card")) : [];
    const searchInput = document.getElementById("project-search");
    const typeFilter = document.getElementById("type-filter");
    const languageFilter = document.getElementById("language-filter");
    const sortSelect = document.getElementById("sort-select");
    if (sortSelect) {
      sortSelect.value = "last-updated";
    }
    let gridAnimationTimeout = null;
    const registeredLanguages = new Set();
    const githubRepoCache = new Map();
    const GITHUB_API_ROOT = "https://api.github.com/repos/";
    const GITHUB_HEADERS = {
      Accept: "application/vnd.github+json",
      "X-GitHub-Api-Version": "2022-11-28",
    };
    const GITHUB_TIMEOUT_MS = 10000;
    const videoToggles = Array.from(document.querySelectorAll("[data-video-toggle]"));

    function extractVideoInfo(url) {
      if (!url) return null;
      try {
        const parsed = new URL(url, window.location.origin);
        const host = parsed.hostname.toLowerCase();
        const pathParts = parsed.pathname.split("/").filter(Boolean);
        if (host.includes("vimeo.com")) {
          const videoIndex = pathParts.findIndex(part => part.toLowerCase() === "video");
          const candidate = videoIndex >= 0 ? pathParts[videoIndex + 1] : pathParts[pathParts.length - 1];
          const cleaned = (candidate || "").split("?")[0].split("#")[0];
          return /^\d+$/.test(cleaned) ? { type: "vimeo", id: cleaned } : null;
        }
        if (host.includes("youtube.com") || host.includes("youtu.be")) {
          let id = parsed.searchParams.get("v");
          if (!id && pathParts.length) {
            id = pathParts[pathParts.length - 1];
          }
          id = (id || "").split("?")[0].split("#")[0];
          return id ? { type: "youtube", id } : null;
        }
      } catch (error) {
        console.warn("[games] Unable to parse video URL", error);
        return null;
      }
      return null;
    }

    function attachVideoPanels() {
      videoToggles.forEach(toggle => {
        const card = toggle.closest(".project-card");
        const label = toggle.querySelector("[data-video-toggle-label]");
        const panel = card ? card.querySelector("[data-video-panel]") : null;
        const frame = panel ? panel.querySelector("[data-video-frame]") : null;
        if (!panel || !frame) return;

        function loadVideo() {
          if (panel.dataset.videoLoaded === "true") return;
          const videoUrl = panel.dataset.vimeoUrl;
          const info = extractVideoInfo(videoUrl);
          if (!info) {
            window.open(videoUrl, "_blank", "noopener,noreferrer");
            return;
          }
          const iframe = document.createElement("iframe");
          iframe.setAttribute("allowfullscreen", "");
          iframe.setAttribute("loading", "lazy");
          iframe.setAttribute("title", panel.dataset.videoTitle || "Gameplay reel");
          iframe.className = "project-card__video-iframe";

          if (info.type === "youtube") {
            const params = new URLSearchParams({
              autoplay: "1",
              mute: "1",
              rel: "0",
              playsinline: "1",
              vq: "hd1080",
            });
            iframe.src = `https://www.youtube-nocookie.com/embed/${info.id}?${params.toString()}`;
            iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share");
          } else if (info.type === "vimeo") {
            const params = new URLSearchParams({
              autoplay: "1",
              muted: "1",
              title: "0",
              byline: "0",
              portrait: "0",
              playsinline: "1",
              dnt: "1",
              autopause: "1",
            });
            iframe.src = `https://player.vimeo.com/video/${info.id}?${params.toString()}`;
            iframe.setAttribute("allow", "autoplay; fullscreen; picture-in-picture");
          }

          frame.innerHTML = "";
          frame.appendChild(iframe);
          panel.dataset.videoLoaded = "true";
        }

        function setState(isOpen) {
          toggle.setAttribute("aria-expanded", isOpen);
          panel.hidden = !isOpen;
          card && card.classList.toggle("is-video-open", isOpen);
          if (label) {
            label.textContent = isOpen ? "Hide reel" : "Show reel";
          }
          if (isOpen) loadVideo();
        }

        toggle.addEventListener("click", event => {
          event.preventDefault();
          const isExpanded = toggle.getAttribute("aria-expanded") === "true";
          setState(!isExpanded);
        });
      });
    }

    attachVideoPanels();

    // "Show build log" toggle
    projectCards.forEach(function (card) {
      const toggle = card.querySelector("[data-project-toggle]");
      const details = card.querySelector("[data-project-details]");
      if (!toggle || !details) return;

      const label = toggle.querySelector("[data-toggle-label]");

      function setState(isOpen) {
        toggle.setAttribute("aria-expanded", isOpen);
        details.hidden = !isOpen;
        card.classList.toggle("is-open", isOpen);
        if (label) {
          label.textContent = isOpen ? "Hide process" : "View process";
        }
      }

      toggle.addEventListener("click", function (event) {
        event.stopPropagation();
        const isExpanded = toggle.getAttribute("aria-expanded") === "true";
        setState(!isExpanded);
      });

      card.addEventListener("click", function (event) {
        if (event.target.closest("a")) return;
        if (event.target.closest("[data-project-toggle]")) return;
        if (event.target.closest("[data-project-details]")) return;
        toggle.click();
      });
    });

    function sortCards(cards, sortValue) {
      switch (sortValue) {
        case "most-recent":
          return [...cards].sort((a, b) => {
            const dateA = new Date(a.dataset.dateAdded);
            const dateB = new Date(b.dataset.dateAdded);
            return dateB - dateA;
          });
        case "name":
          return [...cards].sort((a, b) => {
            const nameA = a.dataset.name;
            const nameB = b.dataset.name;
            return nameA.localeCompare(nameB);
          });
        case "last-updated":
        default:
          return [...cards].sort((a, b) => {
            const dateA = new Date(a.dataset.lastUpdated);
            const dateB = new Date(b.dataset.lastUpdated);
            return dateB - dateA;
          });
      }
    }

    function upsertLanguageOption(label) {
      if (!languageFilter) return;
      const normalized = (label || "").trim().toLowerCase();
      if (!normalized || registeredLanguages.has(normalized)) {
        return;
      }
      registeredLanguages.add(normalized);
      const option = document.createElement("option");
      option.value = normalized;
      option.textContent = label.trim();
      const existing = Array.from(languageFilter.querySelectorAll("option")).slice(1);
      const insertBefore = existing.find(
        element => element.textContent.localeCompare(option.textContent, undefined, { sensitivity: "base" }) > 0
      );
      languageFilter.insertBefore(option, insertBefore || null);
    }

    function populateLanguageFilter() {
      if (!languageFilter) return;
      projectCards.forEach(card => {
        const label = (card.dataset.language || "").trim();
        if (label) {
          upsertLanguageOption(label);
        }
      });
    }

    function animateGridUpdate(callback) {
      if (!projectsGrid) {
        callback();
        return;
      }
      if (gridAnimationTimeout) {
        clearTimeout(gridAnimationTimeout);
        gridAnimationTimeout = null;
      }
      projectsGrid.classList.remove("is-fading");
      // Force reflow so re-adding the class retriggers the transition.
      void projectsGrid.offsetWidth;
      projectsGrid.classList.add("is-fading");
      gridAnimationTimeout = window.setTimeout(() => {
        callback();
        requestAnimationFrame(() => {
          projectsGrid.classList.remove("is-fading");
        });
        gridAnimationTimeout = null;
      }, 250);
    }

    function applyFiltersAndSort(options = { animate: true }) {
      if (!projectsGrid) return;
      const run = () => {
        const query = (searchInput?.value || "").trim().toLowerCase();
        const typeValue = (typeFilter?.value || "").toLowerCase();
        const languageValue = (languageFilter?.value || "").toLowerCase();
        const sortValue = sortSelect ? sortSelect.value : "last-updated";

        const visibleCards = projectCards.filter(card => {
          const name = card.dataset.name || "";
          const summary = card.dataset.summary || "";
          const cardType = (card.dataset.type || "").toLowerCase();
          const language = (card.dataset.languageNormalized || "").toLowerCase();

          const matchesSearch =
            !query || name.includes(query) || summary.includes(query);
          const matchesType = !typeValue || cardType === typeValue;
          const matchesLanguage = !languageValue || language === languageValue;
          const isMatch = matchesSearch && matchesType && matchesLanguage;
          card.hidden = !isMatch;
          return isMatch;
        });

        const hiddenCards = projectCards.filter(card => card.hidden);
        const sortedVisible = sortCards(visibleCards, sortValue);
        sortedVisible.concat(hiddenCards).forEach(card => projectsGrid.appendChild(card));
      };

      if (options.animate) {
        animateGridUpdate(run);
      } else {
        run();
      }
    }

    populateLanguageFilter();

    if (searchInput) {
      searchInput.addEventListener("input", applyFiltersAndSort);
    }
    if (typeFilter) {
      typeFilter.addEventListener("change", applyFiltersAndSort);
    }
    if (languageFilter) {
      languageFilter.addEventListener("change", applyFiltersAndSort);
    }
    if (sortSelect) {
      sortSelect.addEventListener("change", applyFiltersAndSort);
    }

    applyFiltersAndSort({ animate: false });

    function formatUpdatedLabel(value) {
      if (!value) return null;
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return null;
      }
      return date.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function fetchRepositoryMetadata(repo) {
      if (!repo) return Promise.resolve(null);
      if (githubRepoCache.has(repo)) {
        return githubRepoCache.get(repo);
      }
      const controller = new AbortController();
      const timeoutId = window.setTimeout(() => controller.abort(), GITHUB_TIMEOUT_MS);
      const request = fetch(`${GITHUB_API_ROOT}${repo}`, {
        headers: GITHUB_HEADERS,
        signal: controller.signal,
        cache: "no-store",
      })
        .then(response => {
          window.clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`GitHub request for ${repo} failed with status ${response.status}`);
          }
          return response.json();
        })
        .catch(error => {
          window.clearTimeout(timeoutId);
          console.warn(`[projects] Unable to refresh ${repo}`, error);
          return null;
        });
      githubRepoCache.set(repo, request);
      return request;
    }

    function hydrateProjectCard(card) {
      const repo = card.dataset.repo;
      if (!repo) return;
      fetchRepositoryMetadata(repo).then(data => {
        if (!data) return;
        const starsEl = card.querySelector("[data-stars-value]");
        if (starsEl) {
          starsEl.textContent =
            typeof data.stargazers_count === "number"
              ? data.stargazers_count.toLocaleString()
              : "—";
        }
        const forksEl = card.querySelector("[data-forks-value]");
        if (forksEl) {
          forksEl.textContent =
            typeof data.forks_count === "number"
              ? data.forks_count.toLocaleString()
              : "—";
        }

        const updatedAt = data.pushed_at || data.updated_at;
        if (updatedAt) {
          card.dataset.lastUpdated = updatedAt;
        }
        const updatedEl = card.querySelector("[data-updated-value]");
        if (updatedEl) {
          const formatted = formatUpdatedLabel(updatedAt);
          updatedEl.textContent = formatted ? `updated ${formatted}` : "updated —";
        }

        const primaryLanguage = (data.language || "").trim();
        if (primaryLanguage) {
          card.dataset.language = primaryLanguage;
          card.dataset.languageNormalized = primaryLanguage.toLowerCase();
          const languageLabel = card.querySelector("[data-language-label]");
          if (languageLabel) {
            languageLabel.textContent = primaryLanguage;
          }
          upsertLanguageOption(primaryLanguage);
        }

        const type = data.archived ? "archived" : data.fork ? "fork" : "source";
        card.dataset.type = type;

        applyFiltersAndSort({ animate: false });
      });
    }

    projectCards.forEach(card => hydrateProjectCard(card));
  });
</script>
