{% assign cards = include.items %}
{% assign eyebrow = include.eyebrow | default: "latest cycles" %}
{% assign section_title = include.title | default: page.title | default: "projects" %}
{% assign section_description = include.description | default: page.description %}
{% assign empty_message = include.empty_message | default: "More builds coming soon." %}

<section class="projects-page">
  <header class="projects-page__intro">
    <p class="projects-page__eyebrow">{{ eyebrow }}</p>
    <h1 class="projects-page__title">{{ section_title }}</h1>
    <div class="projects-page__header-container">
      {% if section_description %}
        <p class="projects-page__description">{{ section_description }}</p>
      {% endif %}
      <div class="projects-page__sort-controls">
        <label for="sort-select" class="projects-page__sort-label">Sort by:</label>
        <select id="sort-select" class="projects-page__sort-select">
          <option value="last-updated">Last Updated</option>
          <option value="most-recent">Most Recent</option>
          <option value="name">Name</option>
        </select>
      </div>
    </div>
  </header>

  <div class="projects-grid" id="projects-grid">
    {% if cards and cards.size > 0 %}
      {% for item in cards %}
        {% assign repo = item.repo %}
        {% assign project_href = item.url | default: "" %}
        {% if project_href == "" and repo %}
          {% assign project_href = "https://github.com/" | append: repo %}
        {% elsif project_href != "" %}
          {% unless project_href contains "://" %}
            {% assign project_href = project_href | relative_url %}
          {% endunless %}
        {% endif %}
        {% if project_href == "" %}
          {% assign project_href = "#" %}
        {% endif %}
{% assign case_post = nil %}
{% if item.case_study_slug %}
  {% assign case_post = site.posts | where: "slug", item.case_study_slug | first %}
{% endif %}
{% assign has_case_panel = item.case_study_slug %}
{% assign language_label = item.language_label | default: item.language %}
{% assign language_color = item.language_color | default: "rgba(148, 163, 184, 0.6)" %}
{% assign show_language = language_label or item.language_color %}
{% assign project_image = item.image %}
{% if project_image %}
  {% unless project_image contains "://" %}
    {% assign project_image = project_image | relative_url %}
  {% endunless %}
{% endif %}
{% assign image_alt = item.image_alt | default: item.name | default: section_title %}
<article
  class="project-card"
  {% if repo %}data-repo="{{ repo }}"{% endif %}
  data-project-card
  data-name="{{ item.name | downcase }}"
  data-last-updated="{{ item.last_updated }}"
  data-date-added="{{ item.date_added }}"
>
  {% if project_image %}
    <figure class="project-card__media">
      <img src="{{ project_image }}" alt="{{ image_alt }}" loading="lazy" />
    </figure>
  {% endif %}
  <header class="project-card__header">
            <div class="project-card__identity">
              <svg
                class="project-card__icon"
                viewBox="0 0 16 16"
                aria-hidden="true"
                focusable="false"
              >
                <path
                  d="M2 2.75A1.75 1.75 0 0 1 3.75 1h8.5A1.75 1.75 0 0 1 14 2.75v10.5A1.75 1.75 0 0 1 12.25 15H3.75A1.75 1.75 0 0 1 2 13.25Zm1.75-.25a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25Z"
                />
              </svg>
              {% if repo %}
                <a class="project-card__name" href="{{ project_href }}">
                  <span class="project-card__owner">
                    {{ repo | split: "/" | first }}
                  </span>
                  <span class="project-card__slash">/</span>
                  <span class="project-card__repo">
                    {{ repo | split: "/" | last }}
                  </span>
                </a>
              {% else %}
                {% assign display_name = item.display_name | default: item.name | default: section_title %}
                <a class="project-card__name" href="{{ project_href }}">
                  {{ display_name }}
                </a>
              {% endif %}
            </div>
            {% if item.status %}
              <span class="project-card__status">
                {{ item.status }}
              </span>
            {% endif %}
          </header>

          {% if item.summary %}
            <p class="project-card__summary">
              {{ item.summary }}
            </p>
          {% endif %}

          {% assign has_footer = show_language or repo %}
          {% if has_footer %}
            <div class="project-card__footer">
              {% if show_language %}
                <span class="project-card__language">
                  <span
                    class="project-card__language-swatch"
                    data-language-swatch
                    style="--lang-color: {{ language_color }};"
                  ></span>
                  <span class="project-card__language-label" data-language-label>
                    {{ language_label }}
                  </span>
                </span>
              {% endif %}
              {% if repo %}
                <div class="project-card__stats">
                  <span class="project-card__stat project-card__stat--stars">
                    <svg
                      viewBox="0 0 16 16"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path
                        d="M8 .981 10.09 6.26l5.527.2-4.3 3.402 1.434 5.356L8 12.735l-4.75 2.483 1.434-5.356-4.3-3.403 5.527-.199Z"
                      />
                    </svg>
                    <span class="project-card__stat-value" data-stars-value>—</span>
                  </span>
                  <span class="project-card__stat project-card__stat--forks">
                    <svg
                      viewBox="0 0 16 16"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path
                        d="M5.5 3.25a2.25 2.25 0 1 0-3 2.122v2.256a2.25 2.25 0 1 0 1.5 0V5.372a2.251 2.251 0 0 0 1.5-2.122m-2.25.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5m0 6a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5M10.5.5a2.25 2.25 0 0 0-1.5 3.872v5.256a2.25 2.25 0 1 0 1.5 0V4.372A2.25 2.25 0 0 0 10.5.5m0 3a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5m0 8a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5"
                      />
                    </svg>
                    <span class="project-card__stat-value" data-forks-value>—</span>
                  </span>
                  <span class="project-card__stat project-card__stat--updated" data-updated-value>
                    updated — syncing...
                  </span>
                </div>
              {% endif %}
            </div>
          {% endif %}

          {% if has_case_panel %}
            <button
              class="project-card__toggle"
              type="button"
              data-project-toggle
              aria-expanded="false"
            >
              <span data-toggle-label>Show build log</span>
            </button>
            <div class="project-card__details" data-project-details hidden>
              {% if case_post %}
                <article class="project-card__case">
                  <header class="project-card__case-header">
                    <p class="project-card__case-eyebrow">
                      {{ case_post.date | date: "%b %d, %Y" }}
                    </p>
                    <h3 class="project-card__case-title">{{ case_post.title }}</h3>
                  </header>
                  <div class="project-card__case-body">
                    {{ case_post.content }}
                  </div>
                </article>
              {% else %}
                <p class="project-card__case-empty">
                  Build log coming soon.
                </p>
              {% endif %}
            </div>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="projects-page__empty">{{ empty_message }}</p>
    {% endif %}
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // GitHub API fetching
    var cardsWithRepo = document.querySelectorAll(".project-card[data-repo]");
    if (cardsWithRepo.length) {
      var languageColors = {
        JavaScript: "#f1e05a",
        TypeScript: "#3178c6",
        HTML: "#e34c26",
        CSS: "#563d7c",
        SCSS: "#c6538c",
        Ruby: "#701516",
        Python: "#3572a5",
        Shell: "#89e051",
        Markdown: "#083fa1",
        JSON: "#292929"
      };

      cardsWithRepo.forEach(function (card) {
        var repo = card.getAttribute("data-repo");
        if (!repo) return;

        var starsEl = card.querySelector("[data-stars-value]");
        var forksEl = card.querySelector("[data-forks-value]");
        var updatedEl = card.querySelector("[data-updated-value]");
        var languageLabel = card.querySelector("[data-language-label]");
        var languageSwatch = card.querySelector("[data-language-swatch]");

        fetch("https://api.github.com/repos/" + repo, {
          headers: { Accept: "application/vnd.github+json" }
        })
          .then(function (response) {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then(function (repoData) {
            if (starsEl && typeof repoData.stargazers_count === "number") {
              starsEl.textContent = repoData.stargazers_count;
            }

            if (forksEl && typeof repoData.forks_count === "number") {
              forksEl.textContent = repoData.forks_count;
            }

            if (languageLabel && repoData.language) {
              languageLabel.textContent = repoData.language;
            }

            if (languageSwatch && repoData.language) {
              var color =
                languageColors[repoData.language] ||
                "rgba(148, 163, 184, 0.6)";
              languageSwatch.style.setProperty("--lang-color", color);
            }

            if (updatedEl && repoData.pushed_at) {
              var updatedDate = new Date(repoData.pushed_at);
              updatedEl.textContent =
                "updated — " +
                updatedDate.toLocaleDateString(undefined, {
                  month: "short",
                  day: "numeric",
                  year: "numeric"
                });
            }
          })
          .catch(function () {
            if (starsEl) starsEl.textContent = "—";
            if (forksEl) forksEl.textContent = "—";
            if (updatedEl) updatedEl.textContent = "updated — unavailable";
          });
      });
    }

    // "Show build log" toggle
    var detailCards = document.querySelectorAll("[data-project-card]");
    detailCards.forEach(function (card) {
      var toggle = card.querySelector("[data-project-toggle]");
      var details = card.querySelector("[data-project-details]");
      if (!toggle || !details) return;

      var label = toggle.querySelector("[data-toggle-label]");

      function setState(isOpen) {
        toggle.setAttribute("aria-expanded", isOpen);
        details.hidden = !isOpen;
        card.classList.toggle("is-open", isOpen);
        if (label) {
          label.textContent = isOpen ? "Hide build log" : "Show build log";
        }
      }

      toggle.addEventListener("click", function (event) {
        event.stopPropagation();
        var isExpanded = toggle.getAttribute("aria-expanded") === "true";
        setState(!isExpanded);
      });

      card.addEventListener("click", function (event) {
        if (event.target.closest("a")) return;
        if (event.target.closest("[data-project-toggle]")) return;
        if (event.target.closest("[data-project-details]")) return;
        toggle.click();
      });
    });

    // Sorting logic
    const sortSelect = document.getElementById("sort-select");
    const projectsGrid = document.getElementById("projects-grid");
    if (sortSelect && projectsGrid) {
      const projectCards = Array.from(projectsGrid.querySelectorAll(".project-card"));

      sortSelect.addEventListener("change", function () {
        const sortValue = this.value;
        let sortedCards;

        switch (sortValue) {
          case "last-updated":
            sortedCards = [...projectCards].sort((a, b) => {
              const dateA = new Date(a.dataset.lastUpdated);
              const dateB = new Date(b.dataset.lastUpdated);
              return dateB - dateA;
            });
            break;
          case "most-recent":
            sortedCards = [...projectCards].sort((a, b) => {
              const dateA = new Date(a.dataset.dateAdded);
              const dateB = new Date(b.dataset.dateAdded);
              return dateB - dateA;
            });
            break;
          case "name":
            sortedCards = [...projectCards].sort((a, b) => {
              const nameA = a.dataset.name;
              const nameB = b.dataset.name;
              return nameA.localeCompare(nameB);
            });
            break;
        }

        sortedCards.forEach(card => projectsGrid.appendChild(card));
      });
    }
  });
</script>
